<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Michael Shop - å“è³ªä¿è­‰ï¼Œå¿«é€Ÿåˆ°è²¨">
  <title>Michael Shop - å“è³ªä¿è­‰è³¼ç‰©ç¶²</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="header-top">
      Michael Shop Â· æ»¿é¡æŠ˜æ‰£ Â· å…¨é¤¨ 0% åˆ©ç‡
    </div>
    <div class="header-main">
      <a href="/" class="logo">
        <span class="logo-text">Michael</span>
        <span class="logo-badge">Shop</span>
      </a>
      <div class="search-bar">
        <input type="text" placeholder="è¼¸å…¥é—œéµå­—ï¼Œä¾‹å¦‚ï¼šiPhone 15, Dyson, é‹å‹•..." id="searchInput">
        <button type="button">ğŸ”</button>
      </div>
      <div class="header-actions">
        <div class="header-action" id="cartBtn">
          <span class="icon">ğŸ›’</span>
          <span class="cart-count" id="cartCount">0</span>
          <span>è³¼ç‰©è»Š</span>
        </div>
        <div class="header-action" id="authBtn">
          <span class="icon">ğŸ‘¤</span>
          <span id="authText">ç™»å…¥</span>
        </div>
        <div class="user-info" id="userInfo" style="display: none;">
          <span class="user-email" id="userEmail"></span>
          <button class="btn-logout" id="logoutBtn">ç™»å‡º</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Category Navigation -->
  <nav class="category-nav">
    <div class="category-nav-inner">
      <a href="#products" class="category-nav-item active" data-category="all"><span class="icon">ğŸ”¥</span> å…¨éƒ¨å•†å“</a>
      <a href="#products" class="category-nav-item" data-category="3C ç§‘æŠ€"><span class="icon">ğŸ’»</span> 3C ç§‘æŠ€</a>
      <a href="#products" class="category-nav-item" data-category="å±…å®¶ç”Ÿæ´»"><span class="icon">ğŸ </span> å±…å®¶ç”Ÿæ´»</a>
      <a href="#products" class="category-nav-item" data-category="ç¾å¦ä¿é¤Š"><span class="icon">ğŸ’„</span> ç¾å¦ä¿é¤Š</a>
      <a href="#products" class="category-nav-item" data-category="æµè¡Œæœé£¾"><span class="icon">ğŸ‘œ</span> æµè¡Œæœé£¾</a>
      <a href="#products" class="category-nav-item" data-category="éŠæˆ²å¨›æ¨‚"><span class="icon">ğŸ®</span> éŠæˆ²å¨›æ¨‚</a>
    </div>
  </nav>

  <main class="container">
    <!-- Hero Section -->
    <section class="hero-section">
      <div class="hero-banner">
        <img src="https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=1200&h=500&fit=crop" alt="å¤æ—¥æ„Ÿè¬ç¥­">
        <div class="hero-banner-content">
          <span class="hero-banner-tag">é™æ™‚å„ªæƒ </span>
          <h2>å¤æ—¥æ„Ÿè¬ç¥­</h2>
          <p>æŒ‡å®šå®¶é›» 75 æŠ˜èµ·ãƒ»æ»¿é¡å†æŠ½ iPhone 15</p>
          <a href="#products" class="hero-banner-btn">ç«‹å³é¸è³¼</a>
        </div>
      </div>
      <div class="hero-sidebar">
        <div class="sidebar-card">
          <span class="icon">ğŸ”¥</span>
          <h4>ä»Šæ—¥æœ€æ®º</h4>
          <p>é™æ™‚ 24 å°æ™‚</p>
        </div>
        <div class="sidebar-card">
          <span class="icon">ğŸ’</span>
          <h4>é‘½çŸ³å¤§ç´…åŒ…</h4>
          <p>å¤©å¤©é ˜è³¼ç‰©é‡‘</p>
        </div>
      </div>
    </section>

    <!-- Recommended Section -->
    <section class="recommend-section">
      <div class="section-header">
        <div class="section-title">
          <h2>æœ¬å­£æ¨è–¦</h2>
        </div>
        <a href="#" class="section-more">æŸ¥çœ‹æ›´å¤š â†’</a>
      </div>
      <div class="recommend-grid">
        <div class="recommend-card" data-filter="3C ç§‘æŠ€">
          <img src="https://images.unsplash.com/photo-1519389950473-47ba0277781c?w=300&h=300&fit=crop" alt="ç§‘æŠ€">
          <span class="recommend-badge">24h è³¼ç‰©</span>
          <div class="recommend-overlay">
            <span class="recommend-title">3C ç§‘æŠ€æ–°å“</span>
          </div>
        </div>
        <div class="recommend-card" data-filter="å±…å®¶ç”Ÿæ´»">
          <img src="https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=300&h=300&fit=crop" alt="å±…å®¶">
          <span class="recommend-badge">ç†±éŠ·</span>
          <div class="recommend-overlay">
            <span class="recommend-title">å±…å®¶ç”Ÿæ´»å¥½ç‰©</span>
          </div>
        </div>
        <div class="recommend-card" data-filter="ç¾å¦ä¿é¤Š">
          <img src="https://images.unsplash.com/photo-1571781926291-c477ebfd024b?w=300&h=300&fit=crop" alt="ç¾å¦">
          <span class="recommend-badge">24h è³¼ç‰©</span>
          <div class="recommend-overlay">
            <span class="recommend-title">ç¾å¦ä¿é¤Šå°ˆå€</span>
          </div>
        </div>
        <div class="recommend-card" data-filter="æµè¡Œæœé£¾">
          <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=300&h=300&fit=crop" alt="æ™‚å°š">
          <span class="recommend-badge">æ–°å“</span>
          <div class="recommend-overlay">
            <span class="recommend-title">æ™‚å°šç©¿æ­ç²¾é¸</span>
          </div>
        </div>
        <div class="recommend-card" data-filter="éŠæˆ²å¨›æ¨‚">
          <img src="https://images.unsplash.com/photo-1578303512597-81e6cc155b3e?w=300&h=300&fit=crop" alt="éŠæˆ²">
          <span class="recommend-badge">24h è³¼ç‰©</span>
          <div class="recommend-overlay">
            <span class="recommend-title">éŠæˆ²å¨›æ¨‚å°ˆå€</span>
          </div>
        </div>
        <div class="recommend-card" data-filter="hot">
          <img src="https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=300&h=300&fit=crop" alt="ç†±éŠ·">
          <span class="recommend-badge">ğŸ”¥ é™æ™‚</span>
          <div class="recommend-overlay">
            <span class="recommend-title">ä»Šæ—¥ç†±éŠ·æ’è¡Œ</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Products Section -->
    <section class="products-section" id="products">
      <div class="section-header">
        <div class="section-title">
          <h2>ç†±éŠ·å•†å“</h2>
        </div>
        <a href="#" class="section-more">æŸ¥çœ‹æ›´å¤š â†’</a>
      </div>
      <div class="products-grid">
        <% products.forEach(function(product) { %>
          <div class="product-card" data-product-id="<%= product.id %>">
            <div class="product-image">
              <img src="<%= product.image %>" alt="<%= product.name %>">
              <div class="product-badges">
                <% if(product.isHot) { %><span class="badge badge-24h">24h</span>
                  <% } %>
                    <% if(product.isNew) { %><span class="badge badge-new">æ–°å“</span>
                      <% } %>
                        <% if(product.discount) { %><span class="badge badge-sale">
                            <%= product.discount %>æŠ˜
                          </span>
                          <% } %>
              </div>
            </div>
            <div class="product-info">
              <div class="product-category">
                <%= product.category %>
              </div>
              <h3 class="product-name">
                <%= product.name %>
              </h3>
              <div class="product-rating">
                <span class="stars">â˜…â˜…â˜…â˜…â˜…</span>
                <span class="rating-count">(<%= product.reviews %>)</span>
              </div>
              <div class="product-price">
                <span class="current-price">$<%= product.price.toLocaleString() %></span>
                <% if(product.originalPrice) { %>
                  <span class="original-price">$<%= product.originalPrice.toLocaleString() %></span>
                  <% } %>
              </div>
              <div class="product-actions">
                <button class="btn btn-primary add-to-cart" data-product='<%- JSON.stringify(product) %>'>
                  åŠ å…¥è³¼ç‰©è»Š
                </button>
                <button class="btn btn-outline btn-icon">â¤ï¸</button>
              </div>
            </div>
          </div>
          <% }); %>
      </div>
    </section>
  </main>

  <!-- Login Modal -->
  <div class="modal-overlay" id="loginModal">
    <div class="modal">
      <div class="modal-header">
        <h3>ğŸ‘¤ æœƒå“¡ç™»å…¥</h3>
        <button class="modal-close" id="closeLogin">&times;</button>
      </div>
      <div class="modal-body">
        <div style="padding: 10px 0;">
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">é›»å­éƒµä»¶</label>
            <input type="email" id="loginEmail" placeholder="example@email.com"
              style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
          </div>
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">å¯†ç¢¼</label>
            <input type="password" id="loginPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
              style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
          </div>
          <div id="loginError" style="color: #e31937; font-size: 13px; margin-bottom: 10px; display: none;"></div>
          <button id="loginSubmit" class="btn btn-primary" style="width: 100%; padding: 14px;">
            ç™»å…¥
          </button>
          <div style="text-align: center; margin-top: 15px; font-size: 13px; color: #666;">
            æ¸¬è©¦å¸³è™Ÿï¼šmichael@example.com / password123
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div class="modal-overlay" id="cartModal">
    <div class="modal">
      <div class="modal-header">
        <h3>ğŸ›’ è³¼ç‰©è»Š</h3>
        <button class="modal-close" id="closeCart">&times;</button>
      </div>
      <div class="modal-body" id="cartItems">
        <div class="cart-empty">
          <span class="icon">ğŸ›’</span>
          <p>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>
        </div>
      </div>
      <div class="modal-footer">
        <div class="cart-total">
          <span class="cart-total-label">ç¸½è¨ˆ</span>
          <span class="cart-total-price" id="cartTotal">$0</span>
        </div>
        <form id="checkoutForm" action="/checkout" method="POST">
          <input type="hidden" name="cartData" id="cartDataInput">
          <button type="submit" class="btn btn-primary checkout-btn" id="checkoutBtn" disabled>
            å‰å¾€çµå¸³
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-section">
        <h4>é—œæ–¼æˆ‘å€‘</h4>
        <ul>
          <li><a href="#">å“ç‰Œæ•…äº‹</a></li>
          <li><a href="#">åŠ å…¥æˆ‘å€‘</a></li>
          <li><a href="#">åª’é«”å ±å°</a></li>
          <li><a href="#">ESG æ°¸çºŒ</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>é¡§å®¢æœå‹™</h4>
        <ul>
          <li><a href="#">è¨‚å–®æŸ¥è©¢</a></li>
          <li><a href="#">é€€æ›è²¨èªªæ˜</a></li>
          <li><a href="#">å¸¸è¦‹å•é¡Œ</a></li>
          <li><a href="#">ç·šä¸Šå®¢æœ</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>è³¼ç‰©é ˆçŸ¥</h4>
        <ul>
          <li><a href="#">ä»˜æ¬¾æ–¹å¼</a></li>
          <li><a href="#">é…é€èªªæ˜</a></li>
          <li><a href="#">æœƒå“¡æ¬Šç›Š</a></li>
          <li><a href="#">éš±ç§æ¬Šæ”¿ç­–</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>è¿½è¹¤æˆ‘å€‘</h4>
        <ul>
          <li><a href="#">Facebook</a></li>
          <li><a href="#">Instagram</a></li>
          <li><a href="#">LINE</a></li>
          <li><a href="#">YouTube</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <span>Â© 2026 Michael Shop. All Rights Reserved.</span>
      <div class="payment-icons">
        <span class="payment-icon">VISA</span>
        <span class="payment-icon">MasterCard</span>
        <span class="payment-icon">JCB</span>
        <span class="payment-icon">ç¶ ç•Œç§‘æŠ€</span>
      </div>
    </div>
  </footer>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // ==================== å…¨åŸŸè®Šæ•¸ ====================
    let cart = [];
    let currentUser = null;
    let authToken = localStorage.getItem('authToken');

    // DOM Elements
    const cartBtn = document.getElementById('cartBtn');
    const cartModal = document.getElementById('cartModal');
    const closeCart = document.getElementById('closeCart');
    const cartItems = document.getElementById('cartItems');
    const cartTotal = document.getElementById('cartTotal');
    const cartCount = document.getElementById('cartCount');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const cartDataInput = document.getElementById('cartDataInput');
    const toastContainer = document.getElementById('toastContainer');

    const authBtn = document.getElementById('authBtn');
    const authText = document.getElementById('authText');
    const loginModal = document.getElementById('loginModal');
    const closeLogin = document.getElementById('closeLogin');
    const loginSubmit = document.getElementById('loginSubmit');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const loginError = document.getElementById('loginError');

    // ==================== Toast ====================
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = 'toast toast-' + type;
      toast.innerHTML = '<span class="icon">' + (type === 'success' ? 'âœ…' : 'âŒ') + '</span><span>' + message + '</span>';
      toastContainer.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // ==================== API Helpers ====================
    async function apiRequest(url, options = {}) {
      const headers = { 'Content-Type': 'application/json', ...options.headers };
      if (authToken) {
        headers['Authorization'] = 'Bearer ' + authToken;
      }
      const response = await fetch(url, { ...options, headers });
      return response;
    }

    // ==================== ç™»å…¥ç›¸é—œ ====================
    async function checkAuth() {
      if (!authToken) {
        updateAuthUI(null);
        return;
      }

      try {
        const res = await apiRequest('/api/me');
        if (res.ok) {
          const data = await res.json();
          currentUser = data.user;
          updateAuthUI(currentUser);
          loadCartFromServer();
        } else {
          // Token ç„¡æ•ˆ
          localStorage.removeItem('authToken');
          authToken = null;
          updateAuthUI(null);
        }
      } catch (e) {
        console.error('Auth check failed:', e);
      }
    }

    const userInfo = document.getElementById('userInfo');
    const userEmail = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');

    function updateAuthUI(user) {
      if (user) {
        authBtn.style.display = 'none';
        userInfo.style.display = 'flex';
        userEmail.textContent = user.email;
      } else {
        authBtn.style.display = 'flex';
        userInfo.style.display = 'none';
        userEmail.textContent = '';
        cart = [];
        updateCartUI();
      }
    }

    async function handleLogin() {
      const email = loginEmail.value.trim();
      const password = loginPassword.value;

      if (!email || !password) {
        loginError.textContent = 'è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼';
        loginError.style.display = 'block';
        return;
      }

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();

        if (res.ok) {
          authToken = data.user.token;
          localStorage.setItem('authToken', authToken);
          currentUser = data.user;
          updateAuthUI(currentUser);
          loginModal.classList.remove('active');
          loginEmail.value = '';
          loginPassword.value = '';
          loginError.style.display = 'none';
          showToast('æ­¡è¿å›ä¾†ï¼Œ' + data.user.name + 'ï¼');
          loadCartFromServer();
        } else {
          loginError.textContent = data.error || 'ç™»å…¥å¤±æ•—';
          loginError.style.display = 'block';
        }
      } catch (e) {
        loginError.textContent = 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
        loginError.style.display = 'block';
      }
    }

    async function handleLogout() {
      try {
        await apiRequest('/api/logout', { method: 'POST' });
      } catch (e) {
        // ignore
      }
      localStorage.removeItem('authToken');
      authToken = null;
      currentUser = null;
      updateAuthUI(null);
      showToast('å·²ç™»å‡º');
    }

    // ==================== è³¼ç‰©è»Šç›¸é—œ ====================
    async function loadCartFromServer() {
      if (!authToken) return;

      try {
        const res = await apiRequest('/api/cart');
        if (res.ok) {
          const data = await res.json();
          // è½‰æ› API å›å‚³æ ¼å¼
          cart = data.cart.map(item => ({
            id: item.product_id,
            cartItemId: item.id,
            name: item.product_name,
            price: item.product_price,
            image: item.product_image,
            quantity: item.quantity
          }));
          updateCartUI();
        }
      } catch (e) {
        console.error('Load cart failed:', e);
      }
    }

    function updateCartUI() {
      const total = cart.reduce((sum, item) => sum + item.quantity, 0);
      cartCount.textContent = total;

      if (cart.length === 0) {
        cartItems.innerHTML = '<div class="cart-empty"><span class="icon">ğŸ›’</span><p>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p></div>';
        cartTotal.textContent = '$0';
        checkoutBtn.disabled = true;
      } else {
        let html = '';
        let totalPrice = 0;

        cart.forEach((item, index) => {
          totalPrice += item.price * item.quantity;
          html += '<div class="cart-item">' +
            '<div class="cart-item-image"><img src="' + item.image + '" alt="' + item.name + '"></div>' +
            '<div class="cart-item-info">' +
            '<div class="cart-item-name">' + item.name + '</div>' +
            '<div class="cart-item-price">$' + item.price.toLocaleString() + ' Ã— ' + item.quantity + '</div>' +
            '</div>' +
            '<button class="cart-item-remove" onclick="removeFromCart(' + index + ')">ğŸ—‘ï¸</button>' +
            '</div>';
        });

        cartItems.innerHTML = html;
        cartTotal.textContent = '$' + totalPrice.toLocaleString();
        checkoutBtn.disabled = false;
        cartDataInput.value = JSON.stringify({ items: cart, total: totalPrice });
      }
    }

    async function addToCart(product) {
      // æœªç™»å…¥å‰‡å½ˆå‡ºç™»å…¥è¦–çª—
      if (!currentUser) {
        showToast('è«‹å…ˆç™»å…¥æœƒå“¡', 'error');
        loginModal.classList.add('active');
        return;
      }

      try {
        const res = await apiRequest('/api/cart', {
          method: 'POST',
          body: JSON.stringify({ product })
        });

        if (res.ok) {
          // é‡æ–°è¼‰å…¥è³¼ç‰©è»Š
          await loadCartFromServer();
          showToast('å·²åŠ å…¥è³¼ç‰©è»Š');
        } else {
          const data = await res.json();
          showToast(data.error || 'åŠ å…¥å¤±æ•—', 'error');
        }
      } catch (e) {
        showToast('ç¶²è·¯éŒ¯èª¤', 'error');
      }
    }

    async function removeFromCart(index) {
      const item = cart[index];
      if (!item || !item.cartItemId) return;

      try {
        const res = await apiRequest('/api/cart/' + item.cartItemId, { method: 'DELETE' });
        if (res.ok) {
          await loadCartFromServer();
          showToast('å·²ç§»é™¤', 'error');
        }
      } catch (e) {
        showToast('ç§»é™¤å¤±æ•—', 'error');
      }
    }

    // ==================== Event Listeners ====================

    // è³¼ç‰©è»Š Modal
    cartBtn.addEventListener('click', () => cartModal.classList.add('active'));
    closeCart.addEventListener('click', () => cartModal.classList.remove('active'));
    cartModal.addEventListener('click', (e) => { if (e.target === cartModal) cartModal.classList.remove('active'); });

    // ç™»å…¥ Modal
    authBtn.addEventListener('click', () => {
      loginModal.classList.add('active');
    });
    logoutBtn.addEventListener('click', () => {
      handleLogout();
    });
    closeLogin.addEventListener('click', () => loginModal.classList.remove('active'));
    loginModal.addEventListener('click', (e) => { if (e.target === loginModal) loginModal.classList.remove('active'); });
    loginSubmit.addEventListener('click', handleLogin);
    loginPassword.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });

    // åŠ å…¥è³¼ç‰©è»Š
    document.querySelectorAll('.add-to-cart').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const product = JSON.parse(e.currentTarget.dataset.product);
        addToCart(product);
      });
    });

    // ==================== ç”¢å“ç¯©é¸ ====================
    const allProducts = <%- JSON.stringify(products) %>;
    let currentFilter = 'all';

    function filterProducts(filter) {
      currentFilter = filter;
      const productsGrid = document.querySelector('.products-grid');
      const cards = productsGrid.querySelectorAll('.product-card');

      cards.forEach(card => {
        const productId = parseInt(card.dataset.productId);
        const product = allProducts.find(p => p.id === productId);
        if (!product) return;

        let show = false;
        if (filter === 'all') {
          show = true;
        } else if (filter === 'hot') {
          show = product.isHot;
        } else {
          show = product.category === filter;
        }

        card.style.display = show ? '' : 'none';
        if (show) {
          card.style.animation = 'fadeIn 0.3s ease';
        }
      });

      // æ»¾å‹•åˆ°ç”¢å“å€
      document.getElementById('products').scrollIntoView({ behavior: 'smooth' });
    }

    // åˆ†é¡å€é»æ“Š
    document.querySelectorAll('.category-nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const category = item.dataset.category;

        // æ›´æ–° active ç‹€æ…‹
        document.querySelectorAll('.category-nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        filterProducts(category);
        showToast('å·²ç¯©é¸ï¼š' + (category === 'all' ? 'å…¨éƒ¨å•†å“' : category));
      });
    });

    // æœ¬å­£æ¨è–¦é»æ“Š
    document.querySelectorAll('.recommend-card').forEach(card => {
      card.addEventListener('click', () => {
        const filter = card.dataset.filter;

        // æ›´æ–°åˆ†é¡ active ç‹€æ…‹
        document.querySelectorAll('.category-nav-item').forEach(i => {
          i.classList.toggle('active', i.dataset.category === filter || (filter === 'hot' && i.dataset.category === 'all'));
        });

        filterProducts(filter);
        showToast('å·²ç¯©é¸ï¼š' + (filter === 'hot' ? 'ç†±éŠ·å•†å“' : filter));
      });
    });

    // ==================== åˆå§‹åŒ– ====================
    checkAuth();
  </script>
</body>

</html>